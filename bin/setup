#!/bin/sh
cmd='php app/console'

# create necessary dirs
createdir() {
    mkdir -p $1
    echo "- $1 has been created"
}
createdir "app/cache"
createdir "app/logs"
createdir "web/uploads"


# set proper rights
USER=$(whoami)
APACHE_USER=$(ps axho user,comm|grep -E "httpd|apache"|uniq|grep -v "root"|awk 'END {print $1}')
chcache () {
    sudo chmod +a "$USER allow delete,write,append,file_inherit,directory_inherit" $1
    sudo chmod +a "$APACHE_USER allow delete,write,append,file_inherit,directory_inherit" $1
    echo "- $1 has been properly chmod'ed for $USER and $APACHE_USER"
}
if [ -d app/cache ];   then chcache "app/cache"; fi
if [ -d app/logs ];    then chcache "app/logs"; fi
if [ -d web/uploads ]; then chcache "web/uploads"; fi


# set configuration
cp -n app/config/parameters.yml.dist app/config/parameters.yml
echo "- default config copied"
$EDITOR app/config/parameters.yml
echo "- config is set"


# composer stuff
COMPOSER_BIN=composer
command -v $COMPOSER_BIN >/dev/null 2>&1 || {
    echo "system wide composer not found; installing local"
    curl -s https://getcomposer.org/installer | php
    COMPOSER_BIN="php composer.phar"
}
$COMPOSER_BIN install
echo "- composer dependencies installed"


# databases stuff
$cmd doctrine:database:drop --force --quiet
$cmd doctrine:database:create
$cmd doctrine:migrations:migrate --no-interaction
$cmd doctrine:fixtures:load --no-interaction